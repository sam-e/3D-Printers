################################################################################
########################## INTRODUCTION ########################################
# This file contains example configuration for Klipper running on:             #
#                                                                              #
# PRINTER: VZbot 235 x 235                                                     #
# CONTROL_BOARD: Manta M8P v1.1 STM32G0B1                                      #
# OPTIONS: a) 36V on X,Y using BTT HV5160                                      #
#          b) 24V on Z, Extruder using BTT 2209                                # 
#          b) HexTrudort                                                       #
#                                                                              #
# Config example created by:                                                   #
# Date: Sam Contarino December 15th, 2022                                      #
#                                                                              #
################################################################################
################################################################################
# Klipper setup:                                                               #
# Pin mappings - BigTreeTech Manta M8P                                         #
# To use this config:                                                          #
#  a) Firmware should be compiled for the STM32G0B1 with a "8KiB bootloader"  #
#  b) Enable "extra low-level configuration options"                           #
#  c) select the "8MHz crystal" as clock reference                             #
#                                                                              #
################################################################################
################################################################################
#                *** THINGS TO CHANGE/CHECK: ***                               # 
# MCU paths                            [mcu] section                           #
# Thermistor types                     [extruder] and [heater_bed] sections    # 
# Leadscrew Rotation Distance          [stepper_z], [stepper_z1], [stepper_z2] #
# Z Endstop Switch location            [safe_z_home] section                   #
# Z Endstop Switch  offset for Z0      [stepper_z] section                     #
# PID tune                             [extruder] and [heater_bed] sections    #
# Probe pin                            [probe] section                         #
# Fine tune E steps                    [extruder] section                      #
#                                                                              #
################################################################################

####################################################################
####################### Include Files ##############################
####################################################################
[include mainsail.cfg]
[include manta_pin_alias.cfg]



####################################################################
############################ MCU ###################################
####################################################################

[mcu]
serial:/dev/serial/by-id/usb-Klipper_stm32g0b1xx_17004E0010504B4633373520-if00
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:gpiochip0/gpio74
spi_bus: spidev1.1

[resonance_tester]
accel_chip: adxl345
probe_points:
    117, 117, 20  



####################################################################
############################ PRINTER ###############################
####################################################################
[printer]
kinematics: corexy
max_velocity: 2500
max_accel: 10000
max_accel_to_decel: 10000
max_z_velocity: 20
max_z_accel: 1000
square_corner_velocity: 10



####################################################################
############################ XY Axis ###############################
####################################################################
#______________________#### X On MOTOR_1 ####______________________#
[stepper_x]
step_pin: x_step
dir_pin: x_dir
enable_pin: !x_enable
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 400  #set to 400 for 0.9 degree stepper
endstop_pin: ^x_endstop
position_min: -19
position_endstop: -19
position_max: 235
homing_speed: 25   #Max 100
homing_retract_dist: 0

[tmc5160 stepper_x]
cs_pin: x_cs
spi_bus: spi1
run_current: 1.0
driver_TBL: 0
driver_TOFF: 4
driver_HEND: 0
driver_HSTRT: 4

  
#______________________#### X2 On MOTOR_2 ####_____________________#
[stepper_x1]
step_pin: x1_step
dir_pin: x1_dir
enable_pin: !x1_enable
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 400

[tmc5160 stepper_x1]
cs_pin: x1_cs
spi_bus: spi1
run_current: 1.0
driver_TBL: 0
driver_TOFF: 4
driver_HEND: 0
driver_HSTRT: 4


#______________________#### Y On MOTOR_3 ####______________________#
[stepper_y]
step_pin: y_step
dir_pin: y_dir
enable_pin: !y_enable
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 400  
endstop_pin: y_endstop
position_endstop: -0
position_min: -0
position_max: 235
homing_speed: 25  
homing_retract_dist: 0

[tmc5160 stepper_y]
cs_pin: y_cs
spi_bus: spi1
run_current: 1.0
driver_TBL: 0
driver_TOFF: 4
driver_HEND: 0
driver_HSTRT: 4


#______________________#### Y2 On MOTOR_4 ####______________________#
[stepper_y1]
step_pin: y1_step
dir_pin: y1_dir
enable_pin: !y1_enable
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400 

[tmc5160 stepper_y1]
cs_pin: y1_cs
spi_bus: spi1
run_current: 1.0
driver_TBL: 0
driver_TOFF: 4
driver_HEND: 0
driver_HSTRT: 4



####################################################################
############################ Z Axis ################################
####################################################################
#______________________#### Z On MOTOR_6 ####______________________#
[stepper_z]
step_pin: z_step
dir_pin: !z_dir
enable_pin: !z_enable
rotation_distance: 4    # Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: z_endstop
##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##  Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
position_endstop: 0.0
position_max: 190 
position_min: -2.5
homing_speed: 8.0 # Leadscrews are slower than 2.4, 10 is a recommended max.
second_homing_speed: 2.5
homing_retract_dist: 5
#step_pulse_duration: 0.000004

[tmc2209 stepper_z]
uart_pin: z_cs
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0



####################################################################
########################## EXTRUDER ################################
####################################################################
#______________________#### E On MOTOR_7 ####______________________#
[extruder]
#   Heater - BED_OUT
#   Thermistor - T0
### Vz-HextrudORT
step_pin: e_step
dir_pin: e_dir
enable_pin: !e_enable
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
##  Update value below when you perform extruder calibration
##  If you ask for 100mm of filament, but in reality it is 98mm:
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
#Vz-Hextrudort rotation_distance: 4.55  
rotation_distance: 4.55
nozzle_diameter: 0.4
filament_diameter: 1.750
heater_pin: e_heater
#sensor_type: PT1000
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: e_sensor
###
control: pid
pid_kp = 22.348
pid_ki = 1.655
pid_kd = 75.426
min_temp: -200
max_temp: 400
full_steps_per_rotation: 200
max_extrude_only_distance: 1000.0
max_extrude_cross_section: 500
max_extrude_only_velocity: 200
max_extrude_only_accel: 10000
min_extrude_temp: 0
pressure_advance: 0.075
pressure_advance_smooth_time: 0.04
step_pulse_duration: 0.000004

##  E0 on MOTOR5
##  TMC2209
[tmc2209 extruder]
uart_pin: e_cs
interpolate: false
run_current: 0.4
sense_resistor: 0.110
stealthchop_threshold: 0



####################################################################
############################# BED ##################################
####################################################################
[heater_bed]
##  SSR Pin - HE0
##  Thermistor - TB
heater_pin: bed_heater
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for Keenovo heaters
## LDO heaters have their sensor type labelled on the heater
sensor_type: Generic 3950
sensor_pin: bed_sensor
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: -200
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769



####################################################################
############################ FANS ##################################
####################################################################
[fan]
##  Print Cooling Fan - CPAP
##  Control from Raspberry PI GPIO26
pin: parts_cooling_fan
max_power: 1
cycle_time: 0.002
hardware_pwm: false
shutdown_speed: 0

[heater_fan hotend_fan]
##  Hotend Fan - FAN1
pin: toolhead_fan
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
##  If you are experiencing back flow, you can reduce fan_speed
fan_speed: 0.8

[controller_fan controller_fan]
##  Controller fan - FAN2
pin: electronics_fan
max_power: 0.8
kick_start_time: 0.5
heater: heater_bed
stepper: extruder
idle_speed:0.0
fan_speed: 0.8

[controller_fan controller_fan fan_3]
##  Controller fan - FAN3
pin: electronics_fan_2
max_power: 0.8
kick_start_time: 0.5
heater: heater_bed
stepper: extruder
idle_speed:0.0
fan_speed: 0.8

[heater_fan exhaust_fan]
##  Nevemore fan - FAN4
pin: nevermore_fan
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
heater: heater_bed
heater_temp: 60
fan_speed: 1.0



####################################################################
########################## SENSORS #################################
####################################################################
[temperature_sensor chamber]
sensor_type: Generic 3950
pullup_resistor: 4700
sensor_pin: chamber_sensor
min_temp: -200
max_temp: 600
gcode_id: C: C


[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: -2
max_temp: 100



####################################################################
############################ MISC ##################################
####################################################################

[pause_resume]
recover_velocity: 350

########################
########################

[virtual_sdcard]
path: ~/printer_data/gcodes

########################
########################

[display_status]

########################
########################

[bed_screws]
screw1: 20,20
screw2: 20,290
screw3: 290,290
screw4: 290,20

########################
########################

[input_shaper]
shaper_freq_x: 96.2
shaper_type_x: ei
shaper_freq_y: 69
shaper_type_y: mzv

########################
########################

[firmware_retraction]
retract_length: 0.3
retract_speed: 100
unretract_extra_length: 0
unretract_speed: 100

########################
########################

#[filament_switch_sensor sentinel]
#pause_on_runout: true
#switch_pin: PA8
#runout_gcode:
# G91
#    G1 E-30 F2500
#   G90
# G1 X0 Y0 F30000
#   M104 S0

########################
########################

#[homing_override]
#set_position_z: 0
#axes: xy
#gcode:
# G0 Z3 F200
# G28 y0 
# G28 x0
# G28 Z0

########################
########################


####################################################################
##################### Custom Pin Definitions #######################
####################################################################
#[output_pin DSLR]
#pin: rpi:gpio26
#pwm: False
#value: 1
#shutdown_value:1

[output_pin LED]
#In FAN8 position
pin: led
pwm: false
value: 1
shutdown_value:1
### gcode command: SET_PIN PIN=LED value=0 to 1



####################################################################
############################ Macros ################################
####################################################################
[gcode_macro ACCELL_TEST_X]
gcode:

    {% set steps = params.STEPS|default(100)|int %}
    {% set speed = params.VELOCITY|default(1000)|float * 60 %}

    {% set inset = 10.0|float %}
    {% set accel = 30000|int %}
    {% set maxX = printer.configfile.settings.stepper_x.position_max|float - inset %}
    {% set maxY = printer.configfile.settings.stepper_y.position_max|float - inset %}
    {% set minX = printer.configfile.settings.stepper_x.position_min|float + inset %}
    {% set minY = printer.configfile.settings.stepper_y.position_min|float + inset %}

    SAVE_GCODE_STATE NAME=accelltest_state

    SET_VELOCITY_LIMIT ACCEL={accel} 
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL={accel}
    G28
	G1 Z5
    G1 X{minX} Y{minY} F{speed} 

    {% for INTERVAL in range(steps) %}
        {% set eff = accel + (INTERVAL * 1000) %} 
        SET_VELOCITY_LIMIT ACCEL={eff} 
        SET_VELOCITY_LIMIT ACCEL_TO_DECEL={eff}
        G1 X{minX} Y{minY} F{speed}  
        G1 X{maxX} Y{maxY} F{speed}  

    {% endfor %}    

    RESTORE_GCODE_STATE NAME=accelltest_state 
	
	
	
[gcode_macro ACCELL_TEST_Y]
gcode:

    {% set steps = params.STEPS|default(100)|int %}
    {% set speed = params.VELOCITY|default(1000)|float * 60 %}

    {% set inset = 10.0|float %}
    {% set accel = 10000|int %}
    {% set maxX = printer.configfile.settings.stepper_x.position_max|float - inset %}
    {% set maxY = printer.configfile.settings.stepper_y.position_max|float - inset %}
    {% set minX = printer.configfile.settings.stepper_x.position_min|float + inset %}
    {% set minY = printer.configfile.settings.stepper_y.position_min|float + inset %}

    SAVE_GCODE_STATE NAME=accelltest_state

    SET_VELOCITY_LIMIT ACCEL={accel} 
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL={accel}
    G28
	G1 Z5
    G1 X{minX} Y{minY} F{speed} 

    {% for INTERVAL in range(steps) %}
        {% set eff = accel + (INTERVAL * 1000) %} 
        SET_VELOCITY_LIMIT ACCEL={eff} 
        SET_VELOCITY_LIMIT ACCEL_TO_DECEL={eff}
        G1 X{maxX} Y{minY} F{speed}  
        G1 X{minX} Y{maxY} F{speed}  

    {% endfor %}    

    RESTORE_GCODE_STATE NAME=accelltest_state 



[gcode_macro RETRACTION_UP]
gcode:
    {% set CRLEN = printer.firmware_retraction.retract_length|float %}
    {% set NRLEN = CRLEN|float + 0.1 %}
    { action_respond_info("current retract_length %.2f, new retract_length %.2f" % (CRLEN, NRLEN))  }
    SET_RETRACTION RETRACT_LENGTH={NRLEN}    

[gcode_macro RETRACTION_DOWN]
gcode:
    {% set CRLEN = printer.firmware_retraction.retract_length|float %}
    {% set NRLEN = CRLEN|float - 0.1 %}
    { action_respond_info("current retract_length %.2f, new retract_length %.2f" % (CRLEN, NRLEN))  }
    SET_RETRACTION RETRACT_LENGTH={NRLEN}   


#[gcode_macro SET_RETRACTIONLENGTH]
#gcode:
#  SET_RETRACTION RETRACT_LENGTH={params.LENGTH|float}
#  GET_RETRACTION

########################	
[gcode_macro exhaustfan_on]
gcode: 
	SET_FAN_SPEED FAN=Exhaust_fan SPEED=1
###	
	
[gcode_macro exhaustfan_off]
gcode: 
	SET_FAN_SPEED FAN=Exhaust_fan SPEED=0
	
	
###		
	
[gcode_macro enclosurefan_on]
gcode: 
	SET_FAN_SPEED FAN=chamber_fan SPEED=1

###			
	
[gcode_macro enclosurefan_off]
gcode: 
	SET_FAN_SPEED FAN=chamber_fan SPEED=0


[gcode_macro RSCS_on]
gcode: 
	SET_FAN_SPEED FAN=RSCS SPEED=1
###	
	

[gcode_macro RSCS_off]
gcode: 
	SET_FAN_SPEED FAN=RSCS SPEED=0
		
###

[gcode_macro LED_on]
gcode:
	SET_PIN PIN=LED value=1   


[gcode_macro LED_off]
gcode:
	SET_PIN PIN=LED value=0  

###	
	
[gcode_macro PA_tunning]
gcode: 
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=1 ACCEL=500
	TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START=0 FACTOR=.005


#####

[gcode_macro POWER_OFF]
gcode:
  {action_call_remote_method("set_device_power",
                             device="tplink",
                             state="off")}
#####	

[gcode_macro TEST_RESONNANCES_X]
gcode:
 TEST_RESONANCES AXIS=X


[gcode_macro TEST_RESONNANCES_Y]
gcode:
 TEST_RESONANCES AXIS=Y

[gcode_macro DUMP_WARNINGS]
description: Debug: Print all warning messages from klipper
gcode:
  {% set parameters = ["printer.configfile.warnings:"] %}
  {% for warning in printer.configfile.warnings %}
      {% set parameters = parameters.append("%s -> %s -> %s\n%s" % (warning.type, warning.section, warning.option, warning.message)) %}
  {% endfor %}
  {action_respond_info(parameters|join("\n"))}


################################################################################################
################################################################################################